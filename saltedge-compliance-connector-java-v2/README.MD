# Salt Edge Compliance Connector Java Example & SDK (v2)

This codebase was created to demonstrate a full-stack application built on Spring Boot, 
designated to support communication between ASPSP and TPP. 
Current application implements Priora Connector v2 API compatible with **Berlin Group NextGenPSD2 XS2A API**.  
Consists of modules:
* **Example Application** - simulate work of Bank App
* **Connector SDK v.2.1.0** - wrapper of tools for simplification of communication between and Priora PSD2 Compliance Solution  
  
## Application Requirements
  
1. JDK, at least version 8 
1. Spring Boot Framework, at least version 2.2.+
1. Registration & API Keys  
   Follow the guide on how to [register and add API keys](https://priora.saltedge.com/connector-docs#registration-api-keys)

## Example Application Quick Setup

1. Clone project
1. Navigate to project's root folder
    ```bash
    cd saltedge-compliance-connector-java
    ```
1. Create configuration files
    ```bash
    cp example/src/main/resources/application.example.yml example/src/main/resources/application.yml
    cp example/src/main/resources/application.example.properties example/src/main/resources/application.properties
    ```
1. Add secret keys  
    You can generate your RSA key pair using this commands: 
    ```bash
    openssl genrsa -out connector_private_prod.pem 2048
    openssl rsa -pubout -in connector_private_prod.pem -out connector_public_prod.pem
    ```
   > Notice that you must save the content of `connector_public_prod.pem` in your Provider [Dashboard/Settings](https://priora.saltedge.com/providers/settings).
   
   After following the step above, be sure to save your private key generated by openssl in `example/src/main/resources` folder.  
1. Edit configuration files  
    * Example application uses a H2 in memory database (for now), can be changed easily in the `application.properties` for any other database type.
    * Set your external host name in `application.properties`
      ```yaml
      app.url=http://123456789.ngrok.io
      ```
1. Set your external host name in `application.properties`
  ```yaml
  app.url=http://my_host.org
  ``` 

## SDK Integration

1. Add SDK to target application as Module or as JAR library (`out/saltedge-connector-sdk-x.x.x-all.jar`);
1. Setup application as [described before](#example-application-quick-setup)
1. Add SDK package (`com.saltedge.connector.sdk`) to component scan annotation in Application class.
    ```java
    @SpringBootApplication(scanBasePackages = {EXAMPLE_PACKAGE, CONNECTOR_PACKAGE})
    @EnableJpaRepositories(basePackages = {EXAMPLE_PACKAGE, CONNECTOR_PACKAGE})
    @EntityScan(basePackages = {EXAMPLE_PACKAGE, CONNECTOR_PACKAGE})
    public class ExampleApplication {
       public static final String CONNECTOR_PACKAGE = "com.saltedge.connector.sdk";
       
    }
    ```
1. Add `extra` field to `Payment` entity (if not exist) for storing extra data from Salt Edge Compliance solution (e.g. prioraPaymentId).
    The Connector will transmit extra data on Payment creation and require it back at the end of the Payment authentication.
1. Create a service designated for providing information to and receiving events from `Salt Edge PSD2 Compliance`:
   Service should implement `ProviderServiceAbs` interface and should have `@Service` annotation because it is auto-wired in SDK;
    * `getAuthorizationTypes(...)` - return list of registered [Authorization types](https://priora.saltedge.com/providers/settings#authorization_types);
    * `getAuthorizationTypeByCode(...)` - return one of registered [Authorization types](https://priora.saltedge.com/providers/settings#authorization_types);
    * `getAccountInformationAuthorizationPageUrl(...)` - return URL of authorization page for oAuth authorization of User and consent for accounts information;
    * `getAccountsOfUser(...)` - return accounts list of User;
    * `getTransactionsOfAccount(...)` - return transactions list for account of User;
    * `getCardAccountsOfUser(...)` - return list of card accounts of User;
    * `getTransactionsOfCardAccount(...)` - return list of transactions of card account of User;
    * `createPayment(...)` - create a payment order and return payment id or null
    * `getPaymentAuthorizationPageUrl(...)` - return URL of authorization page for payment;  
   
1. Use Connector's SDK callback service `ConnectorCallback` for some events: 
    * `onOAuthAccountsAuthorizationSuccess(sessionSecret, userId, consents)` - notify SDK about the successful authorization if User for AIS flow:  
      - `sessionSecret` - unique authorization secret code passed to application via `getAccountInformationAuthorizationPageUrl(...)`;  
      - `userId` - unique identifier of Provider's system User (Customer);  
      - `consents` - ProviderOfferedConsents object with user consent to provide account information;  

    * `onOAuthAccountsAuthorizationError(sessionSecret)`- notify SDK about the failed authorization:  
      - `sessionSecret` - unique authorization secret code passed to application via `getAccountInformationAuthorizationPageUrl(...)`;
      
    * `onOAuthPaymentAuthorizationSuccess(paymentId, userId, extra)` - notify SDK about the successful authorization if User for AIS flow:  
      - `paymentId` - unique payment id;  
      - `userId` - unique identifier of Provider's system User (Customer);  
      - `extra` - extra data from authenticated Payment passed to application via `getPaymentAuthorizationPageUrl(...)`;  

    * `onOAuthPaymentAuthorizationFail(paymentId, extra)`- notify SDK about the failed authorization:  
      - `paymentId` - unique payment id;
      - `extra` - extra data from authenticated Payment passed to application via `getPaymentAuthorizationPageUrl(...)`;  
  
  
## [Api Documentation](https://priora.banksalt.com/docs/aspsp/v2)
  
---
## [LICENSE](LICENSE.txt)

---
Copyright Â© 2020 Salt Edge. https://www.saltedge.com